name: Auto-Fixing Build Validator

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-and-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Tests
        id: run_tests
        run: set -o pipefail && ./gradlew test 2>&1 | tee build.log
        continue-on-error: true

      - name: Agentic Auto-Fix
        if: steps.run_tests.outcome == 'failure'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          echo "Build failed. Engaging Agent to fix implementation files..."
          
          ./gradlew codeReview \
            -PreviewPrompt="The build is failing. Review and fix the implementation in file (%s) to ensure all unit tests pass and code adheres to best practices." \
            -PreviewSrc="src/main/java" \
            -PreviewThreads=4 \
            -PreviewDocs="build.log"

      - name: Verify Fix
        if: steps.run_tests.outcome == 'failure'
        run: ./gradlew test

      - name: Commit Fixes
        if: steps.run_tests.outcome == 'failure'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "fix: auto-correction by agentic build validator"
          file_pattern: 'src/main/java/**'